#! /usr/bin/env perl6

use v6.c;

use App::Bob;
use App::Bob::Package::Ebuild;
use JSON::Fast;

multi sub MAIN("dist", *@paths, Bool :$force = False)
{
	my Str @absolute-paths;

	for @paths -> $path {
		@absolute-paths.push: $path.IO.absolute;
	}

	for @absolute-paths -> $path {
		chdir $path;

		if (!"./META6.json".IO.e) {
			note "No META6.json in {$path}";
			next;
		}

		my %meta = from-json(slurp("./META6.json"));

		my Str $fqdn = get-dist-fqdn(%meta);
		my Str $basename = $*CWD.IO.basename;
		my Str $transform = "s/^\./{$fqdn}/";
		my Str $output = "{$*HOME}/.local/var/6pan/{$fqdn}.tar.gz";

		if ($output.IO.e && !$force) {
			note "Archive already exists: {$output}";
			next;
		}

		my $proc = run(« tar czf {$output} --transform {$transform} --exclude-vcs --exclude-vcs-ignores --exclude=.[^/]* . », :err);

		say "Created {$output}";
	}
}

multi sub MAIN("pkg", "ebuild", $path where /META6.json$/, Bool :$force = False)
{
	my %meta = from-json(slurp($path));
	my Str $output = make-ebuild(%meta);
	my Str $atom-name = atom-name(%meta<name>, %meta<version>);

	spurt("{$atom-name}.ebuild", $output);

	say "Saved $atom-name";
}
