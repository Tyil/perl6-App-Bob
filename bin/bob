#! /usr/bin/env perl6

use v6.c;

use App::Bob;
use JSON::Fast;

sub MAIN("dist", *@paths, Bool :$force = False)
{
	for @paths -> $path {
		chdir $path;

		if (!"./META6.json".IO.e) {
			note "No META6.json in {$path}";
			next;
		}

		my %meta = from-json(slurp("./META6.json"));

		my Str $fqdn = get-dist-fqdn(%meta);
		my Str $basename = $*CWD.IO.basename;
		my Str $transform = "s/^\./{$fqdn}/";
		my Str $output = "{$*HOME}/.local/var/6pan/{$fqdn}.tar.gz";

		if ($output.IO.e && !$force) {
			note "Archive already exists: {$output}";
			next;
		}

		my $proc = run(« tar czf {$output} --transform {$transform} --exclude-vcs --exclude-vcs-ignores --exclude=.[^/]* . », :err);

		say "Created {$output}";
	}
}
